USE mydb;

-- 1
DROP TABLE IF EXISTS infectious_cases_norm;
DROP TABLE IF EXISTS entities;

CREATE TABLE entities (
  entity_id INT AUTO_INCREMENT PRIMARY KEY,
  Entity VARCHAR(255) NOT NULL,
  Code VARCHAR(50) NULL,
  UNIQUE KEY uq_entity_code (Entity, Code)
);

INSERT IGNORE INTO entities (Entity, Code)
SELECT DISTINCT Entity, NULLIF(Code, '')
FROM infectious_cases;

CREATE TABLE infectious_cases_norm LIKE infectious_cases;

ALTER TABLE infectious_cases_norm
  DROP COLUMN Entity,
  DROP COLUMN Code,
  ADD COLUMN entity_id INT NOT NULL FIRST;

SET SESSION group_concat_max_len = 1000000;

SELECT
  GROUP_CONCAT(CONCAT('`', COLUMN_NAME, '`') ORDER BY ORDINAL_POSITION SEPARATOR ', ')
INTO @col_list
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
  AND TABLE_NAME = 'infectious_cases'
  AND COLUMN_NAME NOT IN ('Entity', 'Code');

SELECT
  GROUP_CONCAT(CONCAT('ic.`', COLUMN_NAME, '`') ORDER BY ORDINAL_POSITION SEPARATOR ', ')
INTO @sel_list
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
  AND TABLE_NAME = 'infectious_cases'
  AND COLUMN_NAME NOT IN ('Entity', 'Code');

SET @sql := CONCAT(
  'INSERT INTO infectious_cases_norm (entity_id, ', @col_list, ') ',
  'SELECT e.entity_id, ', @sel_list, ' ',
  'FROM infectious_cases ic ',
  'JOIN entities e ON e.Entity = ic.Entity AND e.Code <=> NULLIF(ic.Code, '''')'
);

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

SELECT COUNT(*) AS infectious_cases_rows FROM infectious_cases;

-- 2
SELECT
  e.Entity,
  e.Code,
  AVG(r.rabies) AS avg_rabies,
  MIN(r.rabies) AS min_rabies,
  MAX(r.rabies) AS max_rabies,
  SUM(r.rabies) AS sum_rabies
FROM (
  SELECT
    entity_id,
    CAST(NULLIF(Number_rabies, '') AS DECIMAL(20,6)) AS rabies
  FROM infectious_cases_norm
  WHERE NULLIF(Number_rabies, '') IS NOT NULL
) r
JOIN entities e ON e.entity_id = r.entity_id
GROUP BY e.Entity, e.Code
ORDER BY avg_rabies DESC
LIMIT 10;

-- 3
SELECT
  entity_id,
  `Year`,
  MAKEDATE(`Year`, 1) AS year_start_date,
  CURDATE() AS today_date,
  TIMESTAMPDIFF(YEAR, MAKEDATE(`Year`, 1), CURDATE()) AS years_diff
FROM infectious_cases_norm;

-- 4
DROP FUNCTION IF EXISTS years_diff_from_year;
DELIMITER //
CREATE FUNCTION years_diff_from_year(y INT)
RETURNS INT
DETERMINISTIC
RETURN TIMESTAMPDIFF(YEAR, MAKEDATE(y, 1), CURDATE());
// 
DELIMITER ;


SELECT
  e.Entity,
  e.Code,
  ic.entity_id,
  ic.`Year`,
  MAKEDATE(ic.`Year`, 1) AS year_start_date,
  CURDATE() AS today_date,
  years_diff_from_year(ic.`Year`) AS years_diff
FROM infectious_cases_norm ic
JOIN entities e ON e.entity_id = ic.entity_id
ORDER BY e.Entity, ic.`Year`
LIMIT 50;
